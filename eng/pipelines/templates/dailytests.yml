
parameters:
- name: isOfficialBuild
  type: boolean
  default: false
- name: DartLabEnvironment
  displayName: DartLab Environment
  type: string
  default: Production
  values:
  - Production
  - Staging
- name: ApexAgentCleanup
  displayName: Delete or keep VS Apex test machine for debugging
  type: string
  default: delete
  values:
  - delete
  - stop
- name: NuGetLocalizationType
  displayName: Whether to do production-ready localization (Full), or pseudo-localization, aka PLOC, (Pseudo) for testing.
  type: string
  default: Full
  values:
  - Full
  - Pseudo

resources:
  pipelines:
  - pipeline: DartLab
    source: DartLab
    branch: main
  - pipeline: nugetclientprivatedev
    source: NuGet.Client-PrivateDev
    trigger:
        branches:
          - dev-nkolev92-newPipeline
  repositories:
  - repository: DartLabTemplates
    type: git
    name: DartLab.Templates
    ref: refs/heads/main

variables:
  DOTNET_NOLOGO: 1
  Codeql.Enabled: ${{ parameters.isOfficialBuild }}
  Codeql.TSAEnabled: ${{ parameters.isOfficialBuild }}

stages:
- stage: Initialize
  jobs:
  - job: GetSemanticVersion
    displayName: Get NuGet.Client semantic version
    timeoutInMinutes: 10
    pool:
      vmImage: windows-latest
    steps:
    - template: Initialize_Build_SemanticVersion.yml
    - task: DownloadPipelineArtifact@2
      displayName: "Download symbols - NonRTM artifact"
      inputs:
        source: 'specific'
        project: "devdiv"
        pipeline: "NuGet.Client-Official"
        artifact: "symbols - NonRTM"
        path: $(Pipeline.Workspace)\symbols\NonRTM
    - task: PowerShell@1
      displayName: "Print content in folder"
      inputs:
        scriptType: "inlineScript"
        inlineScript: |
          Get-ChildItem $(Pipeline.Workspace)\symbols\NonRTM

    - task: PowerShell@1
      displayName: "Prepare for source link"
      inputs:
        scriptType: "inlineScript"
        inlineScript: |
          try {
            $nugetUrl = "https://github.com/NuGet/NuGet.Client.git"
            if (@(& git remote).Contains("github"))
            {
              $currentGitHubRemoteUrl = & git remote get-url github
              Write-Host "Current github remote URL: $currentGitHubRemoteUrl"
              if ($currentGitHubRemoteUrl -ne $nugetUrl)
              {
                Write-Host "git remote set-url github $nugetUrl"
                & git remote set-url github $nugetUrl
              }
              else
              {
                Write-Host "Git remote url already correct"
              }
            }
            else
            {
              Write-Host "git remote add github $nugetUrl"
              & git remote add github $nugetUrl
            }
          } catch {
            Write-Host "##vso[task.LogIssue type=error;]$Error[0]"
            exit 1
          }

    - task: CodeQL3000Init@0
      displayName: Initialize CodeQL

    - task: MSBuild@1
      displayName: 'Generate .runsettings files'
      inputs:
      solution: 'build\runsettings.proj'
      msbuildArguments: '/restore:false /property:OutputPath="$(Build.Repository.LocalPath)\artifacts\RunSettings" /property:TestDrop="RunSettings/$(System.TeamProject)/$(Build.Repository.Name)/$(Build.SourceBranchName)/$(Build.BuildId)" /property:ProfilingInputsDrop="ProfilingInputs/$(System.TeamProject)/$(Build.Repository.Name)/$(Build.SourceBranchName)/$(Build.BuildId)" /binarylogger:$(Build.StagingDirectory)\\binlog\\16.GenerateRunSettings.binlog'

    - task: artifactDropTask@0
      displayName: 'Publish the .runsettings files to artifact services'
      inputs:
        dropServiceURI: 'https://devdiv.artifacts.visualstudio.com'
        buildNumber: 'RunSettings/$(System.TeamProject)/$(Build.Repository.Name)/$(Build.SourceBranchName)/$(Build.BuildId)'
        sourcePath: 'artifacts\RunSettings'
        toLowerCase: false
        usePat: true
        dropMetadataContainerName: 'DropMetadata-RunSettings'

# Dartlab's template defines this in its own stage
- template: Apex_Tests_On_Windows.yml
  parameters:
    condition: "succeeded()"
    dependsOn:
      - Initialize
    variables:
      - name: VsBootstrapperUrl
        value: $[stageDependencies.Build_Insertable.Build_and_UnitTest_NonRTM.outputs['vsbootstrapper.bootstrapperUrl']]
      - name: GitHubStatusName
        value: Daily Visual Studio Tests
    isOfficialBuild: ${{parameters.isOfficialBuild}}
    runSettingsURI: https://vsdrop.corp.microsoft.com/file/v1/RunSettings/$(System.TeamProject)/$(Build.Repository.Name)/$(Build.SourceBranchName)/$(Build.BuildId);NuGet.Tests.Apex.runsettings
    dartLabEnvironment: ${{parameters.DartLabEnvironment}}
    testExecutionJobTimeoutInMinutes: 150
    bootstrapperUrl: $(VsBootstrapperUrl)
    testMachineCleanUpStrategy: ${{parameters.ApexAgentCleanup}}
